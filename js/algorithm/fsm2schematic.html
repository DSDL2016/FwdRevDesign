<html>
<head>
<title></title>
</head>
<script src="qmSimplify.js"></script> 
<script>

/**
  * For a specfic index in the state string
  * fsm {'10': [{next: '00', out: '0'}, {next: '10', out: '0'}],  ....}
  * => ["101","011"]
  */
function index2truthTable(index, fsm) {
  var arr = [];
  for (let state in fsm) {
    for (let input = 0; input <= 1; input++) {
      if (fsm[state][input].next[index] == '1')
        arr.push(state + input);
    }
  }
  return arr;
}

/** For state
  * fsm {'10': [{next: '00', out: '0'}, {next: '10', out: '0'}],  ....}
  * => [["101","011"],["001"]]
  */
function fsm2stateTruthTable(fsm, totalBit) {
  var arr = [];
  for (let i = 0; i < totalBit; i++)
    arr.push(index2truthTable(i, fsm));
  return arr;
}

/** For output Y
  * fsm {'10': [{next: '00', out: '0'}, {next: '10', out: '0'}],  ....}
  * => ["001","011"]
  */
function fsm2outputTruthTable(fsm) {
  var arr = [];
  for (let state in fsm) {
    for (let input = 0; input <= 1; input++) {
      if (fsm[state][input].out == '1')
        arr.push(state + input);
    }
  }
  return arr;
}

function initSchematic(totalBit) {
  var schematic = {};
  schematic.addGate = function(gate, output) {
    if (typeof output == "undefined")
      schematic[gate] = {out: [[]]};
    else
      schematic[gate] = {out: [[{name: output}]]};
  };

  schematic.addOutputAt = function(gate, output) {
    schematic[gate].out[0].push({name: output});
  };

  schematic.addGate('or output', 'output');
  schematic.addGate('output');
  schematic.addGate('input', 'not input');
  schematic.addGate('not input');
  for (let i = 0; i < totalBit; i++) {
    schematic.addGate('or ' + i, 'dff ' + i);
    schematic.addGate('dff ' + i, 'not ' + i);
    schematic.addGate('not ' + i);
  }
  return schematic;
}

// "101"-> schematic
function addTerm(str, outputIndex, termIndex, schematic) {
  var andGateName = 'and ' + outputIndex + termIndex;
  schematic.addGate(andGateName,'or ' + outputIndex);
  for (let i = 0; i < str.length -1 ; i++) {
      if (str[i] == "x")
        continue;
      schematic.addOutputAt((str[i] == '1' ? 'dff ' + i: 'not ' + i), andGateName);
  }

  // handle input
  if (str[str.length - 1] != 'x')
    schematic.addOutputAt((str[str.length - 1] == '1' ? 'input': 'not input'), andGateName);

  return schematic;
}

// ["101", "011", "1xx"] -> schematic
function addTerms(truthTable, outputIndex, schematic) {
  for (let i = 0; i < truthTable.length; i++)
    schematic = addTerm(truthTable[i], outputIndex, i, schematic);
  return schematic;
}

function stateTruthTables2schematic(truthTables, totalBit) {
  var schematic = initSchematic(totalBit);
  for (let i = 0; i < truthTables.length; i++)
    schematic = addTerms(truthTables[i], i, schematic);
  return schematic;
}






let fsm = {
  '10': [{next: '00', out: '0'}, {next: '10', out: '0'}],
  '00': [{next: '00', out: '0'}, {next: '01', out: '0'}],
  '01': [{next: '00', out: '1'}, {next: '10', out: '1'}]
};

var totalBit = 2;
var stateTruthTables = fsm2stateTruthTable(fsm, totalBit);
var outputTruthTable = fsm2outputTruthTable(fsm);
document.write(JSON.stringify(outputTruthTable) + "<hr><hr>");

outputTruthTable = qmSimplify(outputTruthTable);
for (let i = 0; i < stateTruthTables.length; i++)
  stateTruthTables[i] = qmSimplify(stateTruthTables[i]);

document.write(JSON.stringify(stateTruthTables) + "<hr>");
document.write(JSON.stringify(outputTruthTable) + "<hr>");
var schematic = stateTruthTables2schematic(stateTruthTables, totalBit);
for (let each in schematic) 
  document.write(each + " = " + JSON.stringify(schematic[each]) + "<br>");
document.write("<hr>");
/*
// TODO: refactor schematic
var newSche = func(stateTruthTables);
var schematic = truthTable2Schematic(outputTruthTable, -1);

// print the result
for (let each in schematic) 
  document.write(JSON.stringify(schematic[each]) + "<br>");
document.write("<br>");

var test = truthTable2Schematic(stateTruthTables[0], 0);
for (let each in test) 
  document.write(JSON.stringify(test[each]) + "<br>");
*/
</script>
<body>
</body>
</html> 
